<section style="margin-top:250px">
    <div class="container">
        <div class="row">
            <div class="col-md-6"><input id="tags"><button onclick="addProduct()"type="button">Ajouter</button>
                <input type="hidden" id="tagsID">
                <div class="msg"></div>
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Sélection de vos derniers produits</h4>
                        <h6 class="text-muted card-subtitle mb-2">Ces produits sont ceux que vous avez choisis plusieurs fois durant les 3 derniers mois</h6>
                        <ul class="list-group">
                            {{#each products as | prod |}}
                                <li id="{{prod.id_product}}"class="ols_prod list-group-item"><span>{{prod.name_product}}</span></li>
                            {{/each}}
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h5>Votre liste</h5>
                <form action="/lists/create" method="POST">
                    <ul class="prodlist list-group">
                    </ul>

                    <p>Total : </p><p id="total"></p><p>€</p>

                    <button type="submit">Sauvegarder</button>
                    <input type="hidden" name="_csrf" value="{{csrfToken}}">
                </form>
            </div>
        </div>
    </div>
</section>

<script>
    const total =0;
    $(document).ready(function(){
        $.ajax({
            type: 'post',
            url: '/products/all',
            data: { _csrf: $("input[name='_csrf']").val()},
            dataType: 'json'
        })
        .done(function(data){
            let prodTags = data.map(func)
            console.log(prodTags)
            $("#tags").autocomplete({
                source: prodTags,
                select: function (event, ui) {
                    $("#tags").val(ui.item.label); // display the selected text
                    $("#tagsID").attr("id_prod",ui.item.id); // save selected id to hidden input
                }
            });
        })
        .fail(function(XMLHttpRequest, textStatus, errorThrown) { 
        console.log("Status: " + textStatus); console.log("Error: " + errorThrown);
        }) 
    })
    function func (x){
        return {
            label: x.name_product, 
            id: x.id_product
        }
    }
    function addProduct(){
        const name_p = $('#tags').val();
        const id_p = $('#tagsID').attr("id_prod");
        if(name_p != undefined && id_p != undefined){
            let alreadyIn = false;
            $('.prodlist li').each(function() {
                if($( this ).attr("id")==id_p){
                    alreadyIn = true;
                }      
            })
            if(!alreadyIn){
                $( ".msg div" ).remove();
                let html ="<li id='"+id_p+"'class='list-group-item'><span>"+name_p+"</span><input class='price_prod' name='prices' type='number' min='0'/><input type='hidden' name='ids' value='"+id_p+"'></li>"
                $(html).appendTo( ".prodlist" );
                $('#tags').val('');
            } else {
                $( ".msg div" ).remove();
                let html = "<div class='alert alert-warning'>Ce produit est déjà présent dans votre liste</div>"
                $('#tags').val('');
                $(html).appendTo( ".msg" );
            }
            
        }
    }

    $('.price_prod').focusout(function(){
        console.log('nbgvf')
    })

</script>